<div class="page-header-container">
  <div class="page-context">
    <div class="page-title-container">
      <div class="page-title">
        {{ "transaction." + componentData.componentId | translate }}
      </div>

      <div class="page-secondary-actions">
        <i
          class="fa fa-fw aw-icon aw-icon-with-border"
          [ngClass]="{ 'fa-star': isFavoriteEntry, 'fa-star-o': !isFavoriteEntry }"
          aria-hidden="true"
          (click)="updateFavoriteState()"
          pTooltip="{{ 'page.' + (isFavoriteEntry ? 'removeFromFavorites' : 'addToFavorites') | translate }}"
          tooltipPosition="bottom"
        ></i>
      </div>
    </div>

    <div class="page-subtitle-container">
      <div class="page-subtitle">
        {{ "page.searchPage" | translate }}
      </div>
    </div>
  </div>

  <div class="page-primary-actions">
    <button type="button" mat-raised-button (click)="openNewMaterialRequestSearch()">
      {{ componentData.componentId + ".newSearch" | translate }}
    </button>
  </div>
</div>

<div class="page-wrapper">
  <div class="page-container search-page-container">
    <div class="page-content">
      <div class="grid-row" *ngIf="showSearchPanel">
        <div class="grid-cell--12">
          <div class="grid-cell grid-cell--container">
            <div class="grid-cell-header">
              <div class="grid-cell-title-container">
                <h3 class="grid-cell-title">{{ "global.search" | translate }}</h3>
              </div>
            </div>

            <div class="grid-cell-content">
              <div class="column">
                <div class="row search-criteria-header">
                  <aw-manage-search-criteria
                    [componentId]="SEARCH_CRITERIA_ID"
                    (onSelected)="loadSearchCriteria($event)"
                    (onSavedAsked)="saveSearchCriteriaAsked()"
                    [objectFromPage]="criteriaToSave"
                    [canChange]="!hasBeenCalculated"
                  ></aw-manage-search-criteria>
                </div>
                <div class="row">
                  <div class="grid-cell--12">
                    <div class="grid-cell-content grid-cell-content-with-section">
                      <div class="section">
                        <h4 class="section-title">
                          {{ componentData.componentId + ".supplier" | translate }}
                        </h4>
                        <div class="section-content">
                          <div class="row">
                            <div class="form-group required">
                              <label class="form-label">
                                {{ componentData.componentId + ".site" | translate }}
                              </label>
                              <div class="form-control">
                                <p-dropdown
                                  class="aw-dropdown fixed-width"
                                  [options]="materialRequestSites"
                                  [showClear]="true"
                                  placeholder="&nbsp;"
                                  [(ngModel)]="searchObject.siteId"
                                  (onChange)="loadWarehouses()"
                                ></p-dropdown>
                              </div>
                            </div>

                            <div class="form-group required">
                              <label class="form-label">
                                {{ componentData.componentId + ".warehouseWorkCenter" | translate }}
                              </label>
                              <div class="form-control">
                                <p-dropdown
                                  class="aw-dropdown fixed-width"
                                  [options]="materialRequestWorkCenters"
                                  [showClear]="true"
                                  placeholder="&nbsp;"
                                  [(ngModel)]="searchObject.warehouseId"
                                >
                                </p-dropdown>
                              </div>
                            </div>

                            <div class="form-group required">
                              <label class="form-label">
                                {{ componentData.componentId + ".partner" | translate }}
                              </label>
                              <div class="form-control">
                                <p-dropdown
                                  class="aw-dropdown fixed-width"
                                  [options]="materialRequestPartners"
                                  [showClear]="true"
                                  placeholder="&nbsp;"
                                  [(ngModel)]="searchObject.partnerId"
                                >
                                </p-dropdown>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="section">
                        <h4 class="section-title">
                          {{ componentData.componentId + ".criticity" | translate }}
                        </h4>
                        <div class="section-content">
                          <div class="row">
                            <div class="form-group">
                              <div class="form-control">
                                <p-selectButton
                                  [options]="materialRequestSelectItemList"
                                  [(ngModel)]="searchObject.criticity"
                                ></p-selectButton>
                              </div>
                            </div>

                            <div class="form-group">
                              <label class="form-label">
                                {{ componentData.componentId + ".desiredDate" | translate }}
                              </label>
                              <div class="form-control">
                                <p-calendar
                                  showButtonBar="true"
                                  [monthNavigator]="true"
                                  [yearNavigator]="true"
                                  [yearRange]="sessionService.calendarYearRange"
                                  class="aw-calendar"
                                  [dateFormat]="sessionService.dateFormatPrimeNG"
                                  [locale]="sessionService.calendarFormat"
                                  [readonlyInput]="true"
                                  [(ngModel)]="searchObject.desiredDate"
                                >
                                </p-calendar>
                              </div>
                            </div>
                            <div class="form-group"></div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="row search-criteria-footer">
                  <div class="search-actions">
                    <button
                      type="button"
                      mat-raised-button
                      (click)="search()"
                      color="primary"
                      appKeyPress
                      [keyCode]="'Enter'"
                      (keyPress)="search()"
                    >
                      {{ "global.toSearch" | translate }}
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="grid-row">
        <div class="grid-cell--12">
          <div #resultsContainerAnchor class="grid-cell grid-cell--container">
            <div class="grid-cell-header">
              <div class="grid-cell-title-container">
                <h3 class="grid-cell-title">
                  {{ componentData.componentId + ".materialRequest" | translate }} ({{
                    materialRequestTable ? materialRequestTable.length : 0
                  }})
                </h3>
              </div>
            </div>

            <div class="grid-cell-content">
              <p-table
                [resizableColumns]="true"
                #ptableResults
                class="aw-table2"
                [columns]="materialRequestTableCols"
                [value]="materialRequestTable"
                [(selection)]="selectedMaterialRequests"
                [scrollable]="true"
              >
                <ng-template pTemplate="emptymessage">
                  <span *ngIf="!isLoading"> &nbsp;</span>

                  <div *ngIf="isLoading" class="aw-table-loading-indicator">
                    <div class="loading-message">{{ "table.loadingData" | translate }}</div>
                    <div class="lds-hourglass"></div>
                  </div>
                </ng-template>

                <ng-template pTemplate="caption">
                  <div class="aw-table-header">
                    <div class="aw-table-icon-actions" style="margin-left: 0px;">
                      <i
                        class="fa fa-fw fa-filter aw-icon aw-icon-with-border aw-icon-with-overlay"
                        aria-hidden="true"
                        pTooltip="{{
                          getComponentName() + (filtersVisible ? '.hideFilters' : '.showFilters') | translate
                        }}"
                        tooltipPosition="top"
                        [ngClass]="{ active: filtersVisible }"
                        (click)="opFilters.toggle($event)"
                      ></i>
                    </div>
                    <div class="aw-table-global-filter">
                      <label class="aw-table-global-filter-label">
                        <i class="fa fa-fw fa-search" aria-hidden="true"></i>
                      </label>

                      <input
                        #ptableResultsGlobalFilter
                        class="aw-table-global-filter-input"
                        type="text"
                        placeholder="{{ 'table.globalFilterText' | translate }}"
                        (input)="ptableResults.filterGlobal($event.target.value, 'contains')"
                      />
                    </div>
                  </div>
                </ng-template>

                <ng-template pTemplate="colgroup" let-columns>
                  <colgroup>
                    <col *ngFor="let col of columns" [ngStyle]="{ width: col.width }" />
                    <col [ngStyle]="{ width: '10%' }" />
                  </colgroup>
                </ng-template>

                <ng-template pTemplate="header" let-columns>
                  <tr>
                    <th pResizableColumn *ngFor="let col of columns" [ngStyle]="{ 'text-align': col.alignment }">
                      {{ componentData.componentId + "." + col.field | translate }}
                    </th>
                    <th></th>
                  </tr>
                </ng-template>

                <ng-template pTemplate="body" let-rowData let-columns="columns" let-rowIndex="rowIndex">
                  <tr [pSelectableRow]="rowData" [pSelectableRowIndex]="rowIndex">
                    <td *ngFor="let col of columns" [ngSwitch]="col.field" [ngStyle]="{ 'text-align': col.alignment }">
                      <div *ngSwitchCase="'illustration'" class="flex--1 item-structure-node-image">
                        <img [src]="rowData[col.field]" class="img-dimension" />
                      </div>
                      <div *ngSwitchCase="'references'">
                        <div class="row">
                          <div class="flex--2 font-bold">
                            <a>{{ rowData["sn"] }}</a>
                          </div>
                        </div>
                        <div class="row">
                          <div class="flex--2">{{ componentData.componentId + ".createdBy" | translate }}</div>
                          <div class="flex--2">
                            <a>{{ rowData["createdBy"] }}</a>
                          </div>
                        </div>
                        <div class="row">
                          <div class="flex--2">{{ componentData.componentId + ".createdOn" | translate }}</div>
                          <div class="flex--2 font-bold">{{ rowData["createdOn"] }}</div>
                        </div>
                        <div class="row">
                          <div class="flex--2">{{ componentData.componentId + ".origin" | translate }}</div>
                          <div class="flex--2 font-bold">{{ rowData["origin"] }}</div>
                        </div>
                      </div>
                      <div *ngSwitchCase="'item'">
                        <div class="row">
                          <div class="flex--2">{{ componentData.componentId + ".pn" | translate }}</div>
                          <div class="flex--2 font-bold">
                            <a>{{ rowData["pn"] }}</a>
                          </div>
                        </div>
                        <div class="row">
                          <div class="flex--2">{{ rowData["designation"] }}</div>
                        </div>
                        <div class="row">
                          <div class="flex--2">{{ componentData.componentId + ".quantity" | translate }}</div>
                          <div class="flex--2 font-bold">{{ rowData["quantity"] }}</div>
                        </div>
                        <div class="row">
                          <div class="flex--2">{{ componentData.componentId + ".desiredPotential" | translate }}</div>
                          <div class="flex--2 font-bold">
                            {{ rowData["desiredPotential"] + " " + rowData["potentialUnit"] }}
                          </div>
                        </div>
                      </div>
                      <div *ngSwitchCase="'recepient'">
                        <div class="row">
                          <div class="flex--2">{{ componentData.componentId + ".site" | translate }}</div>
                          <div class="flex--2 font-bold">{{ rowData["site"] }}</div>
                        </div>
                        <div class="row">
                          <div class="flex--2">{{ componentData.componentId + ".warehouse" | translate }}</div>
                          <div class="flex--2 font-bold">{{ rowData["warehouse"] }}</div>
                        </div>
                        <div class="row">
                          <div class="flex--2">{{ componentData.componentId + ".desiredOn" | translate }}</div>
                          <div class="flex--2 font-bold">{{ rowData["desiredOn"] }}</div>
                        </div>
                        <div class="row">
                          <div class="flex--2">{{ componentData.componentId + ".criticity" | translate }}</div>
                          <div class="flex--2">
                            <span style="text-align: center;">
                              <span *ngIf="rowData['criticity'] === 'green'" class="ok">
                                {{ componentData.componentId + ".routine" | translate }}
                              </span>

                              <span *ngIf="rowData['criticity'] === 'red'" class="nok">
                                {{ componentData.componentId + ".immediate" | translate }}
                              </span>

                              <span *ngIf="rowData['criticity'] === 'yellow'" class="warning">
                                {{ componentData.componentId + ".urgent" | translate }}
                              </span>
                            </span>
                          </div>
                        </div>
                      </div>
                      <div *ngSwitchCase="'situation'">
                        <div class="row">
                          <div class="flex--2">{{ componentData.componentId + ".status" | translate }}</div>
                          <div class="flex--2 font-bold">{{ rowData["status"] }}</div>
                        </div>
                        <div class="row">
                          <div class="flex--2">{{ componentData.componentId + ".progress" | translate }}</div>
                          <div class="flex--2 font-bold">{{ rowData["progress"] }}</div>
                        </div>
                        <div class="row">
                          <div class="flex--2">{{ componentData.componentId + ".served" | translate }}</div>
                          <div class="flex--2 font-bold">{{ rowData["served"] }}</div>
                        </div>
                        <div class="row">
                          <div class="flex--2">{{ componentData.componentId + ".booked" | translate }}</div>
                          <div class="flex--2 font-bold">{{ rowData["booked"] }}</div>
                        </div>
                        <div class="row">
                          <div class="flex--2">{{ componentData.componentId + ".notBooked" | translate }}</div>
                          <div class="flex--2 font-bold">{{ rowData["notBooked"] }}</div>
                        </div>
                      </div>
                      <div *ngSwitchDefault>{{ rowData[col.field] }}</div>
                    </td>
                    <td>
                      <button type="button" mat-raised-button (click)="manageMaterialRequest(rowData)">
                        {{ componentData.componentId + ".manage" | translate }}
                      </button>
                    </td>
                  </tr>
                </ng-template>
              </p-table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <p-overlayPanel #opFilters class="aw-overlay" (onShow)="filtersVisible = true" (onHide)="filtersVisible = false">
    <div class="row">
      <div class="form-group flex--1">
        <div class="form-control">
          <label class="form-label"> {{ getComponentName() + ".criticity" | translate }} </label>
        </div>
      </div>
      <div class="form-group flex--2">
        <div class="form-control">
          <p-selectButton
            [options]="filterCriticityList"
            multiple="multiple"
            [(ngModel)]="searchFilterObject.criticity"
          >
          </p-selectButton>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="form-group flex--1">
        <div class="form-control">
          <label class="form-label"> {{ getComponentName() + ".status" | translate }} </label>
        </div>
      </div>
      <div class="form-group flex--2">
        <div class="form-control">
          <p-selectButton [options]="filterStatusList" multiple="multiple" [(ngModel)]="searchFilterObject.status">
          </p-selectButton>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="form-group flex--1">
        <div class="form-control">
          <label class="form-label"> {{ getComponentName() + ".progress" | translate }} </label>
        </div>
      </div>
      <div class="form-group flex--2">
        <div class="form-control">
          <p-selectButton [options]="filterProgressList" multiple="multiple" [(ngModel)]="searchFilterObject.progress">
          </p-selectButton>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="form-group flex--1">
        <div class="form-control">
          <label class="form-label"> {{ getComponentName() + ".origin" | translate }} </label>
        </div>
      </div>
      <div class="form-group flex--2">
        <div class="form-control">
          <p-selectButton [options]="filterOriginList" multiple="multiple" [(ngModel)]="searchFilterObject.origin">
          </p-selectButton>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="form-group flex--1">
        <label class="form-label"> {{ getComponentName() + ".desiredDate" | translate }} </label>
      </div>

      <div class="form-group  flex--1">
        <div class="form-control">
          <p-dropdown
            class="aw-dropdown fixed-width"
            [options]="filterDesiredDateOptions"
            [showClear]="true"
            placeholder="&nbsp;"
            [(ngModel)]="searchFilterObject.desiredOption"
          >
          </p-dropdown>
        </div>
      </div>

      <div class="form-group  flex--1">
        <div class="form-control">
          <p-calendar
            showButtonBar="true"
            [monthNavigator]="true"
            [yearNavigator]="true"
            [yearRange]="sessionService.calendarYearRange"
            class="aw-calendar"
            [dateFormat]="sessionService.dateFormatPrimeNG"
            [locale]="sessionService.calendarFormat"
            [(ngModel)]="searchFilterObject.desiredDate"
          ></p-calendar>
        </div>
      </div>
    </div>

    <div class="row action-list">
      <button type="button" mat-raised-button (click)="resetFilters()">
        {{ "global.reset" | translate }}
      </button>

      <button type="button" mat-raised-button (click)="filterSearchResult()">
        {{ "global.filter" | translate }}
      </button>
    </div>
  </p-overlayPanel>
</div>
