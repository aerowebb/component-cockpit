<div class="page-header">
  <div class="page-info">
    <div>
      <h2 class="page-title">
        {{ "transaction." + componentData.componentId | translate }}
      </h2>
    </div>
  </div>

  <div class="page-actions">
    <button type="button" mat-raised-button (click)="createTransferOrder()">
      {{ "global.create" | translate }}
    </button>

    <button
      mat-icon-button
      class="mat-elevation-z1"
      matTooltip="{{ 'global.showAllActionTooltip' | translate }}"
      matTooltipPosition="above"
      aria-label="Show all actions"
      [matMenuTriggerFor]="actions"
    >
      <mat-icon>more_horiz</mat-icon>
    </button>
    <mat-menu #actions="matMenu">
      <button mat-menu-item (click)="updateFavoriteState()">{{ "addToFavorite" | translate }}</button>
    </mat-menu>
  </div>
</div>

<div class="page-wrapper">
  <div class="page-container">
    <div class="page-content">
      <div class="grid-row">
        <div class="grid-cell--12">
          <div class="grid-cell grid-cell--container" style="height: auto;">
            <div class="grid-cell-header">
              <div class="grid-cell-title-container">
                <h3 class="grid-cell-title">{{ "global.search" | translate }}</h3>
              </div>
            </div>

            <div class="grid-cell-content grid-cell-content-with-section">
              <div class="section">
                <div class="section-content">
                  <div class="row">
                    <div class="form-group flex--2">
                      <label class="form-label"> {{ componentData.componentId + ".criticality" | translate }} </label>

                      <div class="form-control aw-selectbutton-wrapper">
                        <p-selectButton
                          [options]="criticalities"
                          [(ngModel)]="searchCriteria.selectedCriticality"
                        ></p-selectButton>
                      </div>
                    </div>
                    <div class="form-group"></div>
                  </div>
                  <div class="row">
                    <div class="form-group">
                      <label class="form-label"> {{ componentData.componentId + ".references" | translate }} </label>

                      <div class="form-control">
                        <input type="text" [(ngModel)]="searchCriteria.selectedReference" class="aw-input" />
                      </div>
                    </div>
                    <div class="form-group">
                      <label class="form-label"> {{ componentData.componentId + ".type" | translate }} </label>

                      <div class="form-control">
                        <p-dropdown
                          class="aw-dropdown fixed-width"
                          placeholder="&nbsp;"
                          [showClear]="true"
                          [options]="typeList"
                          [(ngModel)]="searchCriteria.selectedType"
                        ></p-dropdown>
                      </div>
                    </div>
                    <div class="form-group">
                      <label class="form-label"> {{ componentData.componentId + ".expectedDate" | translate }} </label>

                      <div class="form-control">
                        <p-calendar
                          showButtonBar="true"
                          [monthNavigator]="true"
                          [yearNavigator]="true"
                          [yearRange]="sessionService.calendarYearRange"
                          class="aw-calendar"
                          [dateFormat]="sessionService.dateFormatPrimeNG"
                          [locale]="sessionService.calendarFormat"
                          [(ngModel)]="searchCriteria.selectedExpectedDate"
                          appendTo="body"
                        ></p-calendar>
                      </div>
                    </div>
                    <div class="form-group">
                      <label class="form-label"> {{ componentData.componentId + ".status" | translate }} </label>

                      <div class="form-control">
                        <p-dropdown
                          class="aw-dropdown fixed-width"
                          placeholder="&nbsp;"
                          [showClear]="true"
                          [options]="statusList"
                          [(ngModel)]="searchCriteria.selectedStatus"
                        ></p-dropdown>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- SUPPLIER CRITERIA -->
              <div class="section">
                <h4 class="section-title">{{ componentData.componentId + ".supplier" | translate }}</h4>

                <div class="section-content">
                  <div class="row">
                    <div class="form-group">
                      <label class="form-label">
                        {{ selectedSupplier | formatSelectOption: suppliers }}
                      </label>

                      <div class="form-control aw-selectbutton-wrapper">
                        <p-selectButton
                          [options]="suppliers"
                          [(ngModel)]="selectedSupplier"
                          (click)="resetInputSupplier()"
                        ></p-selectButton>
                      </div>
                    </div>
                  </div>
                  <div *ngIf="selectedSupplier == component.SUPPLIER_EXTERNAL" class="row">
                    <div class="form-group">
                      <label class="form-label">{{ componentData.componentId + ".partner" | translate }}</label>

                      <div class="form-control form-control-with-modal">
                        <div class="form-control-data" (click)="openCustomerDialog(0)">
                          {{ searchCriteria.selectedPartner }}
                          <span *ngIf="searchCriteria.selectedPartner">({{ searchCriteria.selectedPartner }})</span>
                        </div>

                        <div *ngIf="searchCriteria.selectedPartnerCode" class="btn-clear-wrapper">
                          <i
                            class="ui-dropdown-clear-icon pi pi-times aw-icon btn-clear"
                            aria-hidden="true"
                            (click)="resetSupplierCustomerCode()"
                          ></i>
                        </div>
                        <div class="btn-search-wrapper">
                          <i
                            class="fa fa-fw fa-search aw-icon btn-search"
                            aria-hidden="true"
                            (click)="openCustomerDialog(0)"
                          ></i>
                        </div>
                      </div>
                    </div>
                    <div class="form-group ng-star-inserted"></div>
                  </div>
                  <div *ngIf="selectedSupplier == component.SUPPLIER_INTERNAL" class="row">
                    <div class="form-group">
                      <label class="form-label"> {{ componentData.componentId + ".site" | translate }} </label>

                      <div class="form-control">
                        <p-dropdown
                          class="aw-dropdown fixed-width"
                          placeholder="&nbsp;"
                          [showClear]="true"
                          [(ngModel)]="searchCriteria.selectedSite"
                          [options]="siteList"
                          (onChange)="loadWareHouseList('supplier')"
                        ></p-dropdown>
                      </div>
                    </div>

                    <div class="form-group custom-width">
                      <label class="form-label">{{
                        componentData.componentId +
                          (searchCriteria.warehouseType === awPropertiesConstants.WAREHOUSE_CATEGORY_WAREHOUSE
                            ? ".warehouse"
                            : ".workshop") | translate
                      }}</label>

                      <div class="form-control  aw-selectbutton-wrapper">
                        <p-selectButton
                          [options]="warehouseList"
                          [(ngModel)]="searchCriteria.warehouseType"
                          (onChange)="getSelectedWareHouseList('supplier')"
                        >
                        </p-selectButton>
                      </div>
                    </div>
                    <div class="form-group">
                      <label class="form-label"> &nbsp;</label>

                      <div class="form-control">
                        <p-dropdown
                          class="aw-dropdown fixed-width"
                          placeholder="&nbsp;"
                          [showClear]="true"
                          [(ngModel)]="searchCriteria.selectedWarehouse"
                          [options]="shopList"
                        ></p-dropdown>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- RECIPIENT CRITERIA -->
              <div class="section">
                <h4 class="section-title">{{ componentData.componentId + ".recipient" | translate }}</h4>

                <div class="section-content">
                  <div class="row">
                    <div class="form-group">
                      <label class="form-label">
                        {{ selectedRecipient | formatSelectOption: recipients }}
                      </label>

                      <div class="form-control aw-selectbutton-wrapper">
                        <p-selectButton
                          [options]="recipients"
                          [(ngModel)]="selectedRecipient"
                          (click)="resetInputRecipient()"
                        >
                        </p-selectButton>
                      </div>
                    </div>
                  </div>

                  <div class="row" *ngIf="selectedRecipient == component.RECIPIENT_EXTERNAL">
                    <div class="form-group">
                      <label class="form-label">{{ componentData.componentId + ".partner" | translate }}</label>

                      <div class="form-control form-control-with-modal">
                        <div class="form-control-data" (click)="openCustomerDialog()">
                          {{ searchCriteria.recipientSelectedPartner }}
                          <span *ngIf="searchCriteria.recipientSelectedPartner"
                            >({{ searchCriteria.recipientSelectedPartner }})</span
                          >
                        </div>

                        <div *ngIf="searchCriteria.recipientSelectedPartnerCode" class="btn-clear-wrapper">
                          <i
                            class="ui-dropdown-clear-icon pi pi-times aw-icon btn-clear"
                            aria-hidden="true"
                            (click)="resetRecipientCustomerCode()"
                          ></i>
                        </div>
                        <div class="btn-search-wrapper">
                          <i
                            class="fa fa-fw fa-search aw-icon btn-search"
                            aria-hidden="true"
                            (click)="openCustomerDialog()"
                          ></i>
                        </div>
                      </div>
                    </div>
                    <div class="form-group ng-star-inserted"></div>
                  </div>
                  <div class="row" *ngIf="selectedRecipient == component.RECIPIENT_INTERNAL">
                    <div class="form-group">
                      <label class="form-label"> {{ componentData.componentId + ".site" | translate }} </label>

                      <div class="form-control">
                        <p-dropdown
                          class="aw-dropdown fixed-width"
                          placeholder="&nbsp;"
                          [showClear]="true"
                          [(ngModel)]="searchCriteria.recipientSelectedSite"
                          [options]="siteList"
                          (onChange)="loadWareHouseList('recipient')"
                        ></p-dropdown>
                      </div>
                    </div>

                    <div class="form-group custom-width">
                      <label class="form-label">{{
                        componentData.componentId +
                          (searchCriteria.recipientWarehouseType === awPropertiesConstants.WAREHOUSE_CATEGORY_WAREHOUSE
                            ? ".warehouse"
                            : ".workshop") | translate
                      }}</label>

                      <div class="form-control  aw-selectbutton-wrapper">
                        <p-selectButton
                          [options]="warehouseList"
                          [(ngModel)]="searchCriteria.recipientWarehouseType"
                          (onChange)="getSelectedWareHouseList('recipient')"
                        ></p-selectButton>
                      </div>
                    </div>

                    <div class="form-group">
                      <label class="form-label"> &nbsp;</label>

                      <div class="form-control">
                        <p-dropdown
                          class="aw-dropdown fixed-width"
                          placeholder="&nbsp;"
                          [showClear]="true"
                          [(ngModel)]="searchCriteria.recipientSelectedWarehouse"
                          [options]="recipientshopList"
                        ></p-dropdown>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="section">
                <div class="section-content">
                  <div class="advanced-criteria" [ngClass]="{ 'display--none': !showAdvancedSearchCriteria }">
                    <div class="section">
                      <h4 class="section-title">
                        {{ componentData.componentId + ".referenceDocument" | translate }}
                      </h4>
                      <div class="section-content">
                        <div class="row">
                          <div class="form-group">
                            <label class="form-label">{{ componentData.componentId + ".docType" | translate }} </label>

                            <div class="form-control">
                              <p-dropdown
                                class="aw-dropdown fixed-width"
                                placeholder="&nbsp;"
                                [options]="documentTypes"
                                [showClear]="true"
                                [(ngModel)]="searchCriteria.selectedDocumentType"
                              ></p-dropdown>
                            </div>
                          </div>
                          <div class="form-group">
                            <label class="form-label">
                              {{ componentData.componentId + ".documentNumber" | translate }}
                            </label>
                            <div class="form-control">
                              <input
                                class="aw-input"
                                type="text"
                                [disabled]="searchCriteria.selectedDocumentType == undefined"
                                [(ngModel)]="searchCriteria.selectedDocumentCode"
                              />
                            </div>
                          </div>

                          <div class="form-group flex--2"></div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- ACTION -->
              <div class="section">
                <button mat-button (click)="showAdvancedSearchCriteria = !showAdvancedSearchCriteria">
                  <ng-container *ngIf="showAdvancedSearchCriteria">
                    <mat-icon>remove</mat-icon>
                    {{ "global.collapseCriteria" | translate }}
                  </ng-container>
                  <ng-container *ngIf="!showAdvancedSearchCriteria">
                    <mat-icon>add</mat-icon>
                    {{ "global.expandCriteria" | translate }}
                  </ng-container>
                </button>
                <div class="section-content float-custom">
                  <div class="row search-criteria-footer">
                    <div class="search-actions">
                      <button
                        type="button"
                        mat-raised-button
                        (click)="search()"
                        color="primary"
                        appKeyPress
                        [keyCode]="'Enter'"
                        (keyPress)="search()"
                      >
                        {{ "global.toSearch" | translate }}
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- RESULT TABLE -->
      <div class="grid-row">
        <div class="grid-cell--12">
          <div #resultsContainerAnchor class="grid-cell grid-cell--container">
            <div class="grid-cell-header">
              <div class="grid-cell-title-container">
                <h3 class="grid-cell-title">
                  {{ "global.results" | translate }} ({{ resultsTableDataSource.dataCount }})
                </h3>
              </div>
            </div>

            <div class="grid-cell-content">
              <a-table [dataSource]="resultsTableDataSource">
                <ng-template tableActionsDef>
                  <button
                    *ngIf="resultsTableDataSource.dataSelection.length > 0 && isAllOrderPlanned()"
                    type="button"
                    color="warn"
                    mat-raised-button
                    (click)="cancelSelectedOrder()"
                  >
                    {{ "global.cancel" | translate }}
                  </button>
                  <button
                    *ngIf="resultsTableDataSource.dataSelection.length === 1"
                    type="button"
                    mat-raised-button
                    (click)="openSelectedOrder()"
                  >
                    {{ "global.open" | translate }}
                  </button>
                </ng-template>

                <ng-template columnDef="transferOrder" let-rowData="rowData">
                  <div class="code">
                    <div class="info">
                      <a (click)="openOrder(rowData.transferOrderDto?.bidtTransferOrder.id)"
                        ><b>{{ rowData["transferOrder"] }}</b></a
                      >
                    </div>
                    <div class="info">
                      <i>{{ rowData["transferDesignation"] | extractTranslation }}</i>
                    </div>
                  </div>
                </ng-template>
                <ng-template columnDef="refDocument" let-rowData="rowData">
                  <div class="code">
                    <div class="info">
                      <a (click)="openProcurementRequest(rowData)"
                        ><b>{{ rowData["refNum"] }}</b></a
                      >
                    </div>
                    <div class="info">
                      <i>{{ rowData["refDesignation"] }}</i>
                    </div>
                  </div>
                </ng-template>
                <ng-template columnDef="supplier" let-rowData="rowData">
                  <div class="code">
                    <div class="info">
                      <b *ngIf="rowData['supplierCode']"
                        >{{ rowData["supplierCode"] }} - {{ rowData["supplierName"] }}</b
                      >
                      <b *ngIf="!rowData['supplierCode']"
                        >{{ rowData["supplierCustomerCode"] }} - {{ rowData["supplierCustomerName"] }}</b
                      >
                    </div>
                    <div class="info">
                      <i>{{ rowData["supplierWhName"] }}</i>
                    </div>
                  </div>
                </ng-template>
                <ng-template columnDef="recipient" let-rowData="rowData">
                  <div class="code">
                    <div class="info">
                      <b *ngIf="rowData['recipientCode']"
                        >{{ rowData["recipientCode"] }} - {{ rowData["recipientName"] }}</b
                      >
                      <b *ngIf="!rowData['recipientCode']"
                        >{{ rowData["recipientCustomerCode"] }} - {{ rowData["recipientCustomerName"] }}</b
                      >
                    </div>
                    <div class="info">
                      <i>{{ rowData["recipientWhName"] }}</i>
                    </div>
                  </div>
                </ng-template>
                <ng-template columnDef="article" let-rowData="rowData">
                  <div *ngIf="!rowData['hasMultipleArticle']">
                    <div class="code">
                      <div class="info">
                        <span>
                          <a (click)="openArticle(rowData['articleNum'])"
                            ><b>{{ rowData["articleNum"] }}</b></a
                          >
                          <span *ngIf="rowData['sn'] || rowData['batchNumber']"> / </span>
                          <a (click)="openEquipment(rowData)"
                            ><b>{{ rowData["sn"] }}</b></a
                          >
                          <a *ngIf="!rowData['sn']" (click)="openEquipment(rowData)"
                            ><b>{{ rowData["batchNumber"] }}</b></a
                          >
                        </span>
                      </div>
                      <div class="info">
                        <i>{{ rowData["articleDesignation"] }}</i>
                      </div>
                    </div>
                  </div>
                  <div *ngIf="rowData['hasMultipleArticle']">
                    <i>{{ rowData["quantity"] }} {{ componentData.componentId + ".items" | translate }}</i>
                  </div>
                </ng-template>
                <ng-template columnDef="quantity" let-rowData="rowData">
                  <b *ngIf="!rowData['hasMultipleArticle']">{{ rowData["quantity"] | number }}</b>
                </ng-template>
                <ng-template columnDef="expectedDate" let-rowData="rowData">
                  <span>{{ rowData["expectedDate"] | date: "yyyy/MM/dd" }} </span>
                </ng-template>
                <ng-template columnDef="status" let-rowData="rowData">
                  <div class="code">
                    {{ rowData["status"] }}
                  </div>
                </ng-template>
                <ng-template columnDef="criticality" let-rowData="rowData">
                  <span
                    *ngIf="rowData['criticalityCode'] === awPropertiesConstants.LOGISTICAL_CRITICALITY_IMMEDIATE"
                    class="procurement-alert procurement--nok"
                  >
                    {{ rowData["criticality"] | translate }}
                  </span>
                  <span
                    *ngIf="rowData['criticalityCode'] === awPropertiesConstants.LOGISTICAL_CRITICALITY_URGENT"
                    class="procurement-alert procurement--warning"
                  >
                    {{ rowData["criticality"] | translate }}
                  </span>
                  <span
                    *ngIf="rowData['criticalityCode'] === awPropertiesConstants.LOGISTICAL_CRITICALITY_ROUTINE"
                    class="procurement-alert procurement--ok"
                  >
                    {{ rowData["criticality"] | translate }}
                  </span>
                </ng-template>
              </a-table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<aw-transfer-order-popup
  *ngIf="showCreateTransferOrderDialog"
  [(display)]="showCreateTransferOrderDialog"
  (onValidate)="onCreate($event)"
>
</aw-transfer-order-popup>

<aw-dialog-search-customer
  *ngIf="showCustomerDialog"
  [(display)]="showCustomerDialog"
  [customer-code]="searchCriteria.recipientSelectedPartnerCode"
  (onSelected)="onSelectedCustomer($event)"
>
</aw-dialog-search-customer>
